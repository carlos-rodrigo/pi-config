# Loop Progress Log
Started: Fri Feb 20 13:35:57 -03 2026
Feature: product-agent-ui

## Codebase Patterns

- Product shell interactions should route both slash command and shortcut to a shared `openShell()` helper using `ctx.ui.custom()` with a local component (`render`/`handleInput`/`invalidate`) for predictable behavior.
- Policy loading should be fail-closed: `loadProductAgentPolicy()` returns strict defaults on missing/invalid config and includes a structured `warning` payload (`code` + `message`) so UI can surface fallback reasons.
- Persist workflow mutations (stage changes, approvals, block reasons) through a single snapshot writer (`createWorkflowStateSnapshot` + `pi.appendEntry`) so session recovery logic can replay one canonical custom-entry shape.
- Task artifact loading should be path-safe (`isPathWithinRoot`) and bounded (max file count + max file size) before parsing markdown to avoid traversal and runaway I/O.
- Any markdown/user-derived text rendered in TUI lists should be sanitized for control characters first to avoid terminal escape/control-sequence injection.

---

## 2026-02-20 - Scaffold product-agent-ui extension and workflow shell

Task ID: 001

- Implemented `extensions/product-agent-ui/` scaffold with `index.ts` + `types.ts`.
- Added `/product` command and `Ctrl+Alt+W` shortcut (`Key.ctrlAlt("w")`) to open the minimal Product shell.
- Added base in-memory workflow state (`featureName`, `currentStage`) and stage header rendering for Plan/Design/Tasks/Implement/Review.
- Added input handling for close (`q`/`Esc`) and stage navigation (`←/→`, `h`/`l`) with render-on-change behavior.
- Added task-specific TypeScript validation setup (`npm run typecheck` + `tsconfig.product-agent-ui.json`).
- Files changed:
  - `extensions/product-agent-ui/index.ts`
  - `extensions/product-agent-ui/types.ts`
  - `package.json`
  - `tsconfig.product-agent-ui.json`
  - `.features/product-agent-ui/tasks/001-scaffold-extension-and-shell.md`
  - `.features/product-agent-ui/tasks/_active.md`
  - `scripts/loop/progress-product-agent-ui.txt`
- **Learnings for future iterations:**
  - Keep stage metadata centralized in `types.ts` (`PRODUCT_STAGES` + `DEFAULT_STAGE_ID`) to avoid drift in UI logic.
  - Prefer input handlers returning a `didChange` boolean so `tui.requestRender()` only runs when state actually changes.
  - No automated UI test harness is present yet; for now, treat `npm run typecheck` as the required gate and capture manual interactive verification follow-ups in later tasks.

---

## 2026-02-20 - Policy service with JSON config + strict defaults + README docs

Task ID: 002

- Added `extensions/product-agent-ui/services/policy-service.ts` with a typed `ProductAgentPolicy` model, strict built-in defaults, runtime schema validation, and file loading from `.pi/product-agent-policy.json`.
- Implemented safe fallback behavior for missing, unreadable, invalid JSON, and invalid-schema policy files, returning structured warning metadata for UI consumption.
- Integrated policy loading into `extensions/product-agent-ui/index.ts` so Product shell displays policy source/mode and warning text when fallback is used.
- Documented policy path, schema, defaults, examples, and reload behavior in root `README.md`.
- Validation run:
  - `npm run typecheck`
  - `node --experimental-strip-types --input-type=module` manual checks for missing/valid/invalid policy scenarios
- Files changed:
  - `extensions/product-agent-ui/services/policy-service.ts`
  - `extensions/product-agent-ui/index.ts`
  - `README.md`
  - `.features/product-agent-ui/tasks/002-policy-json-defaults-and-readme.md`
  - `.features/product-agent-ui/tasks/_active.md`
  - `scripts/loop/progress-product-agent-ui.txt`
- **Learnings for future iterations:**
  - Keep policy warnings structured (`code` + human-readable message) so upcoming stage-gating UI can show precise fallback reasons without re-parsing errors.
  - Node `--experimental-strip-types` is useful for quick manual runtime checks on `.ts` services when no test harness exists yet.
  - Until a dedicated test runner is introduced, document manual verification commands per task to keep fallback behavior auditable.

---

## 2026-02-20 - Stage gating + approvals persistence

Task ID: 003

- Added `extensions/product-agent-ui/services/workflow-service.ts` with explicit stage transition guards and approval decision helpers for Plan/Design/Tasks.
- Added `extensions/product-agent-ui/services/state-service.ts` to persist and restore workflow snapshots via `pi.appendEntry("product-agent-state", ...)`.
- Added `extensions/product-agent-ui/components/stage-header.ts` to render per-stage gate statuses (`Draft`, `Needs Approval`, `Approved`, `In Progress`, `Blocked`, `Done`).
- Updated `extensions/product-agent-ui/index.ts` to:
  - block forward transitions when required approvals are missing,
  - support approval/rejection actions (`a` / `r`) with actor/timestamped notes,
  - persist stage/approval/block updates,
  - restore saved workflow state on session start/open.
- Validation run:
  - `npm run typecheck`
- Review run:
  - Oracle code-quality review
  - Oracle security review
  - Oracle performance review
  - Oracle testing-gap review
- Files changed:
  - `extensions/product-agent-ui/index.ts`
  - `extensions/product-agent-ui/types.ts`
  - `extensions/product-agent-ui/components/stage-header.ts`
  - `extensions/product-agent-ui/services/workflow-service.ts`
  - `extensions/product-agent-ui/services/state-service.ts`
  - `.features/product-agent-ui/tasks/003-stage-gating-and-approvals.md`
  - `.features/product-agent-ui/tasks/_active.md`
  - `scripts/loop/progress-product-agent-ui.txt`
- **Learnings for future iterations:**
  - Keep transition checks declarative (`TRANSITION_GATES`) so policy-driven gate behavior remains easy to extend.
  - Treat persisted custom entries as versioned snapshots with strict parsing to avoid loading invalid historical data.
  - There is still no dedicated automated test harness for this feature area; continue documenting verification commands and prioritize adding service-level tests in upcoming tasks.

---

## 2026-02-20 - Implement task parsing and grouped list view

Task ID: 004

- Added `extensions/product-agent-ui/services/task-service.ts` to load `.features/{feature}/tasks/*.md`, parse frontmatter (`id`, `status`, `depends`), normalize statuses, and compute grouped sections in strict `TODO -> In Progress -> Done` order.
- Added guardrails in task loading: feature-path containment checks, file-count/file-size limits, and non-fatal parsing/read warnings.
- Added `extensions/product-agent-ui/components/task-list.ts` for grouped task list rendering with empty-state messages and blocked-task marker (`[blocked]`) in TODO.
- Updated `extensions/product-agent-ui/index.ts` to render grouped task list in the Tasks stage, load policy/task data in parallel, and validate feature names before reading feature artifacts.
- Validation run:
  - `npm run typecheck`
  - `node --experimental-strip-types --input-type=module` task-list snapshot check (group counts + warning state)
- Review run:
  - Oracle code-quality review
  - Oracle security review
  - Oracle performance review
  - Oracle testing-gap review
- Files changed:
  - `extensions/product-agent-ui/index.ts`
  - `extensions/product-agent-ui/components/task-list.ts`
  - `extensions/product-agent-ui/services/task-service.ts`
  - `.features/product-agent-ui/tasks/004-task-service-and-grouped-list.md`
  - `.features/product-agent-ui/tasks/_active.md`
  - `scripts/loop/progress-product-agent-ui.txt`
- **Learnings for future iterations:**
  - Keep task parsing fail-soft: continue rendering valid tasks while surfacing structured warnings instead of crashing the shell.
  - Normalize numeric task IDs (`004`) at parse time so list ordering and dependency references stay consistent.
  - There is still no dedicated automated test harness for this feature area; for this task we used manual runtime verification plus `npm run typecheck` and should add service-level tests in a follow-up.

---
